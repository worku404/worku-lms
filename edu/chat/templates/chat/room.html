{# filepath: c:\Users\hi\Downloads\webdev\Django_Projects\e-learning\edu\chat\templates\chat\room.html #}
{% extends "base.html" %}
{% block title %}Chat room for "{% if course is not None %}{{ course.title }}{% endif %}"{% endblock %}

{% block content %}
{% block motivation %}{% endblock %}
    <section id="chat-room-shell" aria-label="Course chat room">
        <div id="chat" aria-live="polite">
            {% for message in latest_messages %}
                <div class="message {% if message.user == request.user %} me {% else %} other {% endif %}">
                    <div class="meta"> 
                        <strong>
                            {% if message.user == request.user %}Me{% else %}{{ message.user.username }}{% endif %}&nbsp;
                        </strong>
                        <span class="date">{{ message.sent_on|date:"Y.m.d H:i A" }}</span>
                    </div>
                   <div class="text">  {{message.content}}  </div> 
                </div>
            {% empty %}
                <section id="chat-empty-state" class="chat-empty-state" role="status">
                    <div class="chat-empty-state__emoji" aria-hidden="true">ðŸ’¬</div>
                    <h2 class="chat-empty-state__title">Ask anything</h2>
                    <p class="chat-empty-state__text">
                        Your friends can answer your question, or you can start a discussion here.
                    </p>
                </section>
            {% endfor %}
        </div>

        <div id="chat-input">
            <input type="text" id="chat-message-input" autocomplete="off">
            <input type="submit" id="chat-message-submit" value="Send">
        </div>
    </section>
{% endblock %}

{% block include_js %}
    {{ course.id|json_script:"course-id" }}
    {{ request.user.username|json_script:"request-user" }}
{% endblock %}



{% block domready %}
    const courseId = JSON.parse(
        document.getElementById('course-id').textContent
    );
    const requestUser = JSON.parse(
        document.getElementById('request-user').textContent
    );
    
    // --- WebSocket Logic (Keep existing connection) ---
    const url = 'wss://' + window.location.host + '/ws/chat/room/' + courseId + '/';
    const chatSocket = new WebSocket(url);
    const chat = document.getElementById('chat');
    const emptyState = document.getElementById('chat-empty-state');

    const syncEmptyState = () => {
        if (!emptyState) {
            return;
        }
        emptyState.hidden = chat.querySelector('.message') !== null;
    };

    // Scroll to bottom initially
    syncEmptyState();
    chat.scrollTop = chat.scrollHeight;

    chatSocket.onmessage = function(event) {
        const data = JSON.parse(event.data);
        const dateOptions = {hour: 'numeric', minute: 'numeric', hour12: true};
        const datetime = new Date(data.datetime).toLocaleString('en', dateOptions);
        const isMe = data.user === requestUser;
        const source = isMe ? 'me' : 'other';
        const name = isMe ? 'Me' : data.user;

        chat.innerHTML +=
            '<div class="message ' + source + '">' +
                '<div class="meta">' +
                    '<strong>' + name + '</strong> ' +
                    '<span class="date">' + datetime + '</span>' +
                '</div>' +
                '<div class="text">' + data.message + '</div>' +
            '</div>';
        syncEmptyState();

        // Only auto-scroll if user was already near bottom
        chat.scrollTop = chat.scrollHeight;
    };

    chatSocket.onclose = function(event) {
        console.error('Chat socket closed unexpectedly.');
    };

    const input = document.getElementById('chat-message-input');
    const submitButton = document.getElementById('chat-message-submit');

    submitButton.addEventListener('click', function() {
        const message = input.value.trim();
        if (message) {
            chatSocket.send(JSON.stringify({ 'message': message }));
            input.value = '';
            input.focus();
        }
    });

    input.addEventListener('keypress', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            submitButton.click();
        }
    });

    // --- INFINITE SCROLL LOGIC ---
    let page = 2; // We already loaded page 1 (first 100) via Django template
    let blockRequest = false;
    let emptyPage = false; 

    chat.addEventListener('scroll', function() {
        // Check if scrolled to top (scrollTop is 0)
        if (this.scrollTop === 0 && !blockRequest && !emptyPage) {
            blockRequest = true;
            
            // Save current scroll height to restore position later
            const previousHeight = chat.scrollHeight;

            // Fetch older messages
            fetch(`/chat/history/${courseId}/?page=${page}`)
            .then(response => response.json())
            .then(data => {
                if (data.messages.length === 0) {
                    emptyPage = true;
                } else {
                    let html = '';
                    data.messages.forEach(msg => {
                        const source = msg.is_me ? 'me' : 'other';
                        const name = msg.is_me ? 'Me' : msg.user;
                        
                        html += `
                            <div class="message ${source}">
                                <div class="meta">
                                    <strong>${name}</strong>
                                    <span class="date">${msg.sent_on}</span>
                                </div>
                                <div class="text">${msg.content}</div>
                            </div>
                        `;
                    });

                    // Insert OLD messages at the TOP
                    chat.insertAdjacentHTML('afterbegin', html);
                    syncEmptyState();
                    
                    // Restore scroll position so user sees the same message they were looking at
                    chat.scrollTop = chat.scrollHeight - previousHeight;
                    
                    page += 1;
                    blockRequest = false;
                }
            })
            .catch(err => {
                console.error('Error fetching history:', err);
                blockRequest = false;
            });
        }
    });
{% endblock %}
