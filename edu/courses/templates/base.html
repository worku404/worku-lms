{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{% endblock %}</title>
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
</head>
<body class="app-body{% if request.user.is_authenticated %} has-assistant assistant-hidden{% endif %}">
    <a class="skip-link" href="#main-content">Skip to main content</a>

    <header id="header" class="topbar">
        <div class="topbar__inner">
        <a href="{% url 'course_list' %}" class="topbar__brand" aria-label="Edu Home">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="url(#goldPinkGradient)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="brand-icon">
                <defs>
                    <linearGradient id="goldPinkGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" stop-color="#ffd54f" />
                        <stop offset="100%" stop-color="#ff9ec5" />
                    </linearGradient>
                </defs>
                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
            </svg>
            <span class="brand-text">
                <span class="brand-primary">{{request.user.username }}</span><span class="brand-divider">-</span><span class="brand-secondary">Edu</span>
            </span>

        </a>

            <form class="c-search topbar__search" action="{% url 'course_list' %}" method="get" role="search" aria-label="Search courses">
                <label class="u-sr-only" for="global-search">Search courses</label>
                <input
                    id="global-search"
                    class="c-search__input"
                    name="q"
                    type="search"
                    value="{{ request.GET.q|default:'' }}"
                    placeholder="Search courses, topics, instructors"
                >
                <button type="submit" class="c-btn c-btn--ghost">Search</button>
            </form>

            <nav class="topbar__actions" aria-label="Account actions">
                {% if request.user.is_authenticated %}
                    <a href="{% url 'student_course_list' %}" class="c-btn c-btn--ghost">My Courses</a>
                {% endif %}
                    <a href="{% url 'api:token_ui' %}" class="c-btn c-btn--ghost">API</a>
                    <a href="#"
                        id="theme-toggle-link"
                        class="c-btn c-btn--ghost"
                        role="button"
                        aria-pressed="false"
                        aria-label="Toggle dark mode">

                            <span class="theme-icon" aria-hidden="true"></span>

                        </a>
                {% if request.user.is_authenticated %}
                    <form action="{% url 'logout' %}" method="post">
                        <button type="submit" class="c-btn c-btn--secondary">Sign out</button>
                        {% csrf_token %}
                    </form>
                {% else %}
                    <a href="{% url 'login' %}" class="c-btn c-btn--primary">Sign in</a>
                {% endif %}
            </nav>
        </div>
    </header>

    <main class="l-shell">
        <aside class="l-rail l-rail--left" aria-label="Primary navigation">
            <nav class="c-nav">
                <a href="{% url 'course_list' %}" class="c-nav__item{% if request.path == '/' %} is-active{% endif %}">Dashboard</a>
                <a href="{% url 'student_course_list' %}" class="c-nav__item{% if '/students/courses/' in request.path %} is-active{% endif %}">Enrolled</a>
                <a href="{% url 'course_list' %}" class="c-nav__item{% if '/course/' in request.path %} is-active{% endif %}">Catalog</a>
                {% if request.user.is_staff or request.user.is_superuser %}
                    <a href="{% url 'manage_course_list' %}" class="c-nav__item{% if '/course/mine/' in request.path %} is-active{% endif %}">Manage</a>
                {% endif %}
            </nav>
            {% block motivation %}
            {% if request.user.is_authenticated %}
            <section class="c-card c-progress-card" aria-label="Progress snapshot">
                <h2 class="c-card__title">Weekly Focus</h2>
                <p class="c-card__meta">Keep your momentum: complete 3 learning sessions this week.</p>
                <div class="c-progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="42" aria-label="Weekly focus progress">
                    <span class="c-progress__bar" style="width:42%"></span>
                </div>
                <p class="c-progress__text">42% complete</p>
            </section>
            {% endif %}
            {% endblock %}
        </aside>

        <section id="content" class="l-main" aria-label="Learning workspace">
            <div id="main-content" class="l-main__inner">
                {% block content %}{% endblock %}
            </div>
        </section>

        <aside class="l-util" aria-label="Tools and assistant">
            {% if request.user.is_authenticated %}
<button
    id="assistant-unhide"
    class="assistant-unhide"
    type="button"
    aria-label="Show W-AI assistant"
    aria-controls="assistant-panel"
    aria-expanded="true"
>
    <svg 
        xmlns="http://www.w3.org/2000/svg" 
        width="24" 
        height="24" 
        viewBox="0 0 24 24" 
        fill="none" 
        stroke="currentColor" 
        stroke-width="2.5" 
        stroke-linecap="round" 
        stroke-linejoin="round"
        aria-hidden="true"
    >
        <path d="M4 11 L8 21 L12 14 L16 21 L20 11" />
        <path d="M19 2 L20 5 L23 6 L20 7 L19 10 L18 7 L15 6 L18 5 Z" fill="currentColor" stroke="none" />
        <path d="M7 3 L7.5 4.5 L9 5 L7.5 5.5 L7 7 L6.5 5.5 L5 5 L6.5 4.5 Z" fill="currentColor" stroke="none" />
    </svg>
</button>
                <section id="assistant-panel" class="assistance c-ai-panel">
                    {% block ai %}
                        {% include "assistant/llm.html" %}
                    {% endblock %}
                </section>
            {% else %}
                <section class="c-card c-alert c-alert--info">
                    <h2 class="c-card__title">AI Study Assistant</h2>
                    <p class="c-card__meta">Sign in to access AI guidance, contextual summaries, and quick study support.</p>
                </section>
            {% endif %}
        </aside>
    </main>

    {% block include_js %}{% endblock %}
    <script>
        (function () {
            const themeStorageKey = "theme_preference";
            const body = document.body;
            const toggleLink = document.getElementById("theme-toggle-link");

            if (!body || !toggleLink) return;

            const applyTheme = (mode) => {
                const darkModeEnabled = mode === "dark";
                body.classList.toggle("theme-dark", darkModeEnabled);
                const icon = toggleLink.querySelector(".theme-icon");

                if (icon) {
                    icon.innerHTML = darkModeEnabled
                        ? `<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                            <circle cx="12" cy="12" r="5"/>
                            <g stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="1" x2="12" y2="4"/>
                                <line x1="12" y1="20" x2="12" y2="23"/>
                                <line x1="4.22" y1="4.22" x2="6.34" y2="6.34"/>
                                <line x1="17.66" y1="17.66" x2="19.78" y2="19.78"/>
                                <line x1="1" y1="12" x2="4" y2="12"/>
                                <line x1="20" y1="12" x2="23" y2="12"/>
                                <line x1="4.22" y1="19.78" x2="6.34" y2="17.66"/>
                                <line x1="17.66" y1="6.34" x2="19.78" y2="4.22"/>
                            </g>
                        </svg>`
                        : `<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                            <path d="M21 12.79A9 9 0 0 1 11.21 3
                                    7 7 0 1 0 21 12.79z"/>
                        </svg>`;
                }
                toggleLink.setAttribute("aria-pressed", String(darkModeEnabled));
            };

            let preferredMode = "light";
            try {
                const storedMode = localStorage.getItem(themeStorageKey);
                if (storedMode === "dark" || storedMode === "light") {
                    preferredMode = storedMode;
                }
            } catch (error) {
                preferredMode = "light";
            }

            applyTheme(preferredMode);

            toggleLink.addEventListener("click", function (event) {
                event.preventDefault();
                const nextMode = body.classList.contains("theme-dark") ? "light" : "dark";
                applyTheme(nextMode);
                try {
                    localStorage.setItem(themeStorageKey, nextMode);
                } catch (error) {
                    // Ignore storage failures.
                }
            });
        })();

        document.addEventListener('DOMContentLoaded', (event) => {
            // DOM loaded
            {% block domready %} {% endblock %}
        })
    </script>
</body>
</html>
